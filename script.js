// --- ÈùôÊÄÅÊï∞ÊçÆ ---
let articles = [];
let comments = [];
const categories = ['ÊäÄÊúØ', 'ÁîüÊ¥ª', 'ÂÖ∂‰ªñ'];

// --- ÂÖ®Â±ÄÂèòÈáè ---
let previewedAvatarData = null;
let intersectionObserver = null;
let currentOpenReplyForm = null;

// === ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ ===
const themeToggleButton = document.getElementById('themeToggle');
const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

function applyTheme(theme) {
    const html = document.documentElement;
    if (theme === 'dark') {
        html.classList.add('dark-mode');
        document.body.classList.add('dark-mode');
        if (themeToggleButton) {
            themeToggleButton.innerHTML = '‚òÄÔ∏è';
            themeToggleButton.title = 'ÂàáÊç¢Âà∞ÁôΩÂ§©Ê®°Âºè';
        }
    } else {
        html.classList.remove('dark-mode');
        document.body.classList.remove('dark-mode');
        if (themeToggleButton) {
            themeToggleButton.innerHTML = 'üåô';
            themeToggleButton.title = 'ÂàáÊç¢Âà∞Â§úÈó¥Ê®°Âºè';
        }
    }
    try {
        localStorage.setItem('theme', theme);
        initializeParticles();
    } catch (e) {
        console.error('‰∏ªÈ¢ò‰øùÂ≠òÂ§±Ë¥•:', e);
    }
}

function toggleTheme() {
    const isDark = document.documentElement.classList.contains('dark-mode');
    applyTheme(isDark ? 'light' : 'dark');
}

function initializeTheme() {
    let savedTheme;
    try {
        savedTheme = localStorage.getItem('theme');
    } catch (e) {}
    const initialTheme = savedTheme ? savedTheme : (prefersDarkScheme.matches ? 'dark' : 'light');
    applyTheme(initialTheme);
    if (themeToggleButton) {
        themeToggleButton.addEventListener('click', toggleTheme);
    }
}

// === Á≤íÂ≠êÂä®ÁîªËÉåÊôØÂàùÂßãÂåñ ===
function initializeParticles() {
    if (!window.particlesJS) {
        console.error('particles.js Êú™Âä†ËΩΩ');
        return;
    }

    if (window.pJSDom && window.pJSDom.length) {
        window.pJSDom.forEach(p => p.pJS.fn.vendors.destroypJS());
        window.pJSDom = [];
    }

    particlesJS('particles-js', {
        particles: {
            number: {
                value: 80,
                density: { enable: true, value_area: 800 }
            },
            color: {
                value: document.documentElement.classList.contains('dark-mode') ? '#92c1de' : '#5a7d9a'
            },
            shape: {
                type: 'circle',
                stroke: { width: 0, color: '#000000' }
            },
            opacity: {
                value: 0.6,
                random: true,
                anim: { enable: true, speed: 1, opacity_min: 0.2, sync: false }
            },
            size: {
                value: 4,
                random: true,
                anim: { enable: true, speed: 2, size_min: 1, sync: false }
            },
            line_linked: {
                enable: true,
                distance: 120,
                color: document.documentElement.classList.contains('dark-mode') ? '#92c1de' : '#5a7d9a',
                opacity: 0.5,
                width: 1
            },
            move: {
                enable: true,
                speed: 3,
                direction: 'none',
                random: true,
                straight: false,
                out_mode: 'out',
                bounce: false
            }
        },
        interactivity: {
            detect_on: 'canvas',
            events: {
                onhover: { enable: true, mode: 'grab' },
                onclick: { enable: true, mode: 'push' },
                resize: true
            },
            modes: {
                grab: {
                    distance: 150,
                    line_linked: { opacity: 0.8 }
                },
                push: {
                    particles_nb: 6
                },
                repulse: {
                    distance: 100,
                    duration: 0.4
                }
            }
        },
        retina_detect: true
    });

    console.log('Á≤íÂ≠êÂä®ÁîªÂ∑≤ÂàùÂßãÂåñ');
}

// === Scroll Animation Logic ===
function initializeScrollAnimations() {
    disconnectScrollAnimations();
    const elements = document.querySelectorAll('.animate-on-scroll');
    if (!elements.length) return;
    const options = { root: null, rootMargin: '0px', threshold: 0.1 };
    intersectionObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
                observer.unobserve(entry.target);
            }
        });
    }, options);
    elements.forEach(el => intersectionObserver.observe(el));
}

function disconnectScrollAnimations() {
    if (intersectionObserver) {
        intersectionObserver.disconnect();
        intersectionObserver = null;
    }
}

// --- Â∑•ÂÖ∑ÂáΩÊï∞ ---
function showNotification(message, type = 'info') {
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    notification.onclick = () => notification.remove();
    setTimeout(() => {
        if (document.body.contains(notification)) notification.remove();
    }, 3500);
}

function compressImage(file, isAvatar = true) {
    return new Promise((resolve, reject) => {
        if (!file || !file.type) return reject(new Error('Êó†ÊïàÊñá‰ª∂'));
        if (!file.type.match(/image\/(jpeg|png)/)) return reject(new Error('‰ªÖÊîØÊåÅJPG/PNG'));
        const sizeLimit = isAvatar ? 2 * 1024 * 1024 : 10 * 1024 * 1024;
        const limitMB = sizeLimit / (1024 * 1024);
        if (file.size > sizeLimit) return reject(new Error(`${isAvatar ? 'Â§¥ÂÉè' : 'ÊñáÁ´†'}ÂõæÁâáÈúÄÂ∞è‰∫é${limitMB}MB`));
        const mimeType = file.type;
        const maxSizePx = isAvatar ? 300 : 1920;
        const quality = isAvatar ? 0.8 : (mimeType === 'image/jpeg' ? 0.85 : undefined);
        const reader = new FileReader();
        reader.onload = (e) => {
            if (!e.target?.result) return reject(new Error('Êó†Ê≥ïËØªÂèñÊñá‰ª∂'));
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let { width, height } = img;
                if (width > maxSizePx || height > maxSizePx) {
                    const ratio = width / height;
                    if (width > height) {
                        width = maxSizePx;
                        height = Math.round(width / ratio);
                    } else {
                        height = maxSizePx;
                        width = Math.round(height * ratio);
                    }
                }
                canvas.width = Math.max(1, width);
                canvas.height = Math.max(1, height);
                const ctx = canvas.getContext('2d');
                if (!ctx) return reject(new Error('Êó†Ê≥ïËé∑ÂèñCanvas‰∏ä‰∏ãÊñá'));
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                try {
                    const dataUrl = canvas.toDataURL(mimeType, quality);
                    if (!dataUrl || dataUrl === 'data:,') throw new Error('Data URL‰∏∫Á©∫');
                    resolve(dataUrl);
                } catch (err) {
                    reject(new Error(`ÂéãÁº©Â§±Ë¥•: ${err.message}`));
                }
            };
            img.onerror = () => reject(new Error('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•'));
        };
        reader.onerror = () => reject(new Error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•'));
        reader.readAsDataURL(file);
    });
}

function highlightText(text, query) {
    if (!text) return '';
    if (!query) return text;
    const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    try {
        const regex = new RegExp(`(${safeQuery})`, 'gi');
        return String(text).replace(regex, '<mark>$1</mark>');
    } catch (e) {
        return text;
    }
}

function showImageModal(src) {
    if (document.querySelector('.image-modal')) return;
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.innerHTML = `<span class="close" title="ÂÖ≥Èó≠(Esc)">√ó</span><img src="${src}" alt="ÂõæÁâáÈ¢ÑËßà">`;
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    const closeBtn = modal.querySelector('.close');
    const removeModal = () => {
        if (document.body.contains(modal)) modal.remove();
        document.removeEventListener('keydown', escapeKeyListener);
    };
    closeBtn.onclick = removeModal;
    modal.onclick = (e) => {
        if (e.target === modal) removeModal();
    };
    const escapeKeyListener = (e) => {
        if (e.key === 'Escape') removeModal();
    };
    document.addEventListener('keydown', escapeKeyListener);
}

// --- Êú¨Âú∞Â≠òÂÇ®Â§¥ÂÉèÁõ∏ÂÖ≥ ---
function loadAvatar() {
    try {
        const savedAvatar = localStorage.getItem('userAvatar');
        const profileAvatar = document.getElementById('profileAvatar');
        if (savedAvatar && profileAvatar) profileAvatar.src = savedAvatar;
        else if (profileAvatar) profileAvatar.onerror = () => {
            profileAvatar.src = '';
            profileAvatar.alt = 'Â§¥ÂÉèÂä†ËΩΩÂ§±Ë¥•';
        };
    } catch (e) {}
}

function initAvatarUpload() {
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    const uploadButton = document.getElementById('uploadAvatarButton');
    const profileAvatar = document.getElementById('profileAvatar');
    const avatarLabel = document.querySelector('.avatar-upload-label');
    if (!avatarInput || !avatarPreview || !uploadButton || !profileAvatar || !avatarLabel) return;

    // Á°Æ‰øùÁÇπÂáªÊ†áÁ≠æÂè™Ëß¶Âèë‰∏ÄÊ¨°Êñá‰ª∂ÈÄâÊã©
    const triggerFileInput = (e) => {
        e.preventDefault();
        avatarInput.click();
    };
    avatarLabel.addEventListener('click', triggerFileInput);

    avatarInput.onchange = async () => {
        const file = avatarInput.files ? avatarInput.files[0] : null;
        uploadButton.disabled = true;
        avatarPreview.style.display = 'none';
        previewedAvatarData = null;
        if (!file) return;
        try {
            showNotification('Ê≠£Âú®Â§ÑÁêÜÂõæÁâá...', 'info');
            const compressed = await compressImage(file, true);
            previewedAvatarData = compressed;
            avatarPreview.src = compressed;
            avatarPreview.style.display = 'block';
            uploadButton.disabled = false;
            showNotification('È¢ÑËßàÁîüÊàêÊàêÂäü', 'success');
        } catch (e) {
            showNotification(`Â§ÑÁêÜÂ§±Ë¥•: ${e.message || 'Êú™Áü•ÈîôËØØ'}`, 'error');
            avatarInput.value = '';
        }
    };

    uploadButton.onclick = async () => {
        if (!previewedAvatarData) {
            showNotification('ËØ∑ÂÖàÈÄâÊã©ÂõæÁâá', 'error');
            return;
        }
        try {
            localStorage.setItem('userAvatar', previewedAvatarData);
            profileAvatar.src = previewedAvatarData;
            await saveAvatarToFirebase(previewedAvatarData);
            avatarInput.value = '';
            avatarPreview.src = '';
            avatarPreview.style.display = 'none';
            uploadButton.disabled = true;
            previewedAvatarData = null;
        } catch (e) {
            showNotification(`‰øùÂ≠òÂ§±Ë¥•: ${e.message || 'Êú™Áü•ÈîôËØØ'}`, 'error');
        }
    };
}

// --- ÊñáÁ´†ÂíåËØÑËÆ∫Ê∏≤Êüì ---
async function saveData() {
    await db.ref('articles').set(Object.fromEntries(articles.map(a => [a.id, a])));
    await db.ref('comments').set(Object.fromEntries(comments.map(c => [c.id, c])));
    showNotification('Êõ¥ÊîπÂ∑≤ÂêåÊ≠•Âà∞‰∫ëÁ´Ø', 'success');
}

function renderArticles(filteredArticles, query = '', page = 1, perPage = 5) {
    const articleList = document.querySelector('.article-list');
    if (!articleList) return;
    const existingPagination = document.querySelector('.pagination');
    if (existingPagination) existingPagination.remove();
    articleList.innerHTML = '';
    const start = (page - 1) * perPage;
    const end = start + perPage;
    const paginatedArticles = filteredArticles.slice(start, end);
    if (paginatedArticles.length === 0) {
        articleList.innerHTML = `<div class="empty animate-on-scroll">${page === 1 ? 'Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑÊñáÁ´†ÔºÅ' : 'Â∑≤Âà∞ËææÊúÄÂêé‰∏ÄÈ°µ„ÄÇ'}</div>`;
        initializeScrollAnimations();
        return;
    }
    paginatedArticles.forEach(article => {
        if (!article || !article.id) return;
        const div = document.createElement('div');
        div.className = 'article animate-on-scroll';
        const summary = (article.content || '').replace(/\n/g, ' ').substring(0, 120) + ((article.content || '').length > 120 ? '...' : '');
        const imageSrc = (Array.isArray(article.images) && article.images[0]) ? article.images[0] : '';
        div.innerHTML = `
            ${imageSrc ? `<img src="${imageSrc}" alt="${(article.title || 'ÊñáÁ´†') + ' ÂõæÁâá'}" onerror="this.style.display='none';">` : ''}
            <div style="display:none; width: 200px; height: 130px; background:#eee; align-items: center; justify-content:center; text-align:center; line-height:1.2; color:#aaa; font-size:12px; border-radius: 6px;">ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•</div>
            <div class="content">
                <h2><a href="#article/${article.id}" class="article-link" data-id="${article.id}">${highlightText(article.title || 'Êó†È¢ò', query)}</a></h2>
                <p>${highlightText(summary, query)}</p>
                <p>ÂàÜÁ±ª: ${article.category || 'ÂÖ∂‰ªñ'} | Êó•Êúü: ${article.date || 'Êú™Áü•'}</p>
                <div class="article-actions">
                    ${isAdmin() ? `<button class="edit-button" data-id="${article.id}" title="ÁºñËæëÊñáÁ´†">ÁºñËæë</button><button class="delete-button" data-id="${article.id}" title="Âà†Èô§ÊñáÁ´†">Âà†Èô§</button>` : ''}
                </div>
            </div>`;
        articleList.appendChild(div);
        const img = div.querySelector('img');
        if (img && imageSrc) {
            img.style.cursor = 'pointer';
            img.onclick = (e) => {
                e.stopPropagation();
                showImageModal(imageSrc);
            };
        }
    });
    const totalPages = Math.ceil(filteredArticles.length / perPage);
    if (totalPages > 1) {
        const pagination = document.createElement('div');
        pagination.className = 'pagination animate-on-scroll';
        pagination.innerHTML = page > 1
            ? `<button data-page="${page - 1}" title="‰∏ä‰∏ÄÈ°µ">¬´</button>`
            : `<button disabled title="Â∑≤ÊòØÈ¶ñÈ°µ">¬´</button>`;
        const maxPages = 5;
        let startPage = Math.max(1, page - Math.floor(maxPages / 2));
        let endPage = Math.min(totalPages, startPage + maxPages - 1);
        if (endPage - startPage + 1 < maxPages) startPage = Math.max(1, endPage - maxPages + 1);
        if (startPage > 1) {
            pagination.innerHTML += `<button data-page="1">1</button>`;
            if (startPage > 2) pagination.innerHTML += `<span>...</span>`;
        }
        for (let i = startPage; i <= endPage; i++) {
            pagination.innerHTML += `<button ${i === page ? 'class="active"' : ''} data-page="${i}">${i}</button>`;
        }
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) pagination.innerHTML += `<span>...</span>`;
            pagination.innerHTML += `<button data-page="${totalPages}">${totalPages}</button>`;
        }
        pagination.innerHTML += page < totalPages
            ? `<button data-page="${page + 1}" title="‰∏ã‰∏ÄÈ°µ">¬ª</button>`
            : `<button disabled title="Â∑≤ÊòØÊú´È°µ">¬ª</button>`;
        articleList.insertAdjacentElement('afterend', pagination);
    }
    initializeScrollAnimations();
}

async function showEditForm(articleId) {
    if (!isAdmin()) {
        showNotification('Âè™ÊúâÁÆ°ÁêÜÂëòÂèØ‰ª•ÁºñËæëÊñáÁ´†', 'error');
        window.location.hash = '#home';
        return;
    }
    disconnectScrollAnimations();
    const article = articles.find(a => String(a.id) === String(articleId));
    if (!article) {
        showNotification('Êú™ÊâæÂà∞ÊñáÁ´†', 'error');
        window.location.hash = '#home';
        return;
    }
    const content = document.getElementById('content');
    if (!content) return;
    content.innerHTML = `
        <div class="animate-on-scroll">
            <h1>ÁºñËæëÊñáÁ´†</h1>
            <form id="editArticleForm" class="edit-article-form" novalidate>
                <label for="articleTitle">Ê†áÈ¢ò:</label>
                <input type="text" id="articleTitle" value="${article.title || ''}" required>
                <label for="articleCategory">ÂàÜÁ±ª:</label>
                <select id="articleCategory" required>
                    ${categories.map(cat => `<option value="${cat}" ${cat === article.category ? 'selected' : ''}>${cat}</option>`).join('')}
                </select>
                <label for="articleContent">ÂÜÖÂÆπ:</label>
                <textarea id="articleContent" required>${article.content || ''}</textarea>
                <label for="articleImage">ÂõæÁâáÔºàÊúÄÂ§ö5Âº†Ôºâ:</label>
                <input type="file" id="articleImage" accept="image/jpeg,image/png" multiple>
                <div class="image-preview" id="imagePreview"></div>
                <div style="display:flex;gap:10px;margin-top:10px;">
                    <button type="submit">‰øùÂ≠òÊõ¥Êîπ</button>
                    <button type="button" id="cancelEditButton">ÂèñÊ∂à</button>
                </div>
            </form>
        </div>`;
    const previewContainer = content.querySelector('#imagePreview');
    const imageInput = content.querySelector('#articleImage');
    let currentImages = [...(article.images || [])];

    function renderPreviews() {
        previewContainer.innerHTML = '';
        currentImages.forEach((src, idx) => {
            const div = document.createElement('div');
            div.className = 'image-container';
            div.innerHTML = `
                <img src="${src}" alt="È¢ÑËßàÂõæÁâá${idx + 1}" onerror="this.alt='ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•';this.parentNode.style.display='none';">
                <button type="button" class="delete-image" data-index="${idx}" title="Âà†Èô§ÂõæÁâá">√ó</button>`;
            previewContainer.appendChild(div);
            const imgTag = div.querySelector('img');
            if (imgTag) imgTag.onclick = () => showImageModal(src);
            div.querySelector('.delete-image').onclick = (e) => {
                const index = parseInt(e.target.dataset.index, 10);
                if (!isNaN(index) && index < currentImages.length) {
                    currentImages.splice(index, 1);
                    renderPreviews();
                }
            };
        });
        if (currentImages.length === 0) previewContainer.innerHTML = '<p style="color:#888;font-size:14px;width:100%;text-align:center;">ÊöÇÊó†ÂõæÁâá</p>';
    }
    renderPreviews();

    let newFiles = [];
    imageInput.onchange = async function() {
        const files = Array.from(this.files);
        if (files.length === 0) return;
        if (files.length + currentImages.length > 5) {
            showNotification(`ÊúÄÂ§öÂèØ‰∏ä‰º†5Âº†ÂõæÁâáÔºàÂΩìÂâçÂ∑≤Êúâ${currentImages.length}Âº†Ôºâ`, 'error');
            this.value = '';
            return;
        }
        newFiles = files;
        previewContainer.querySelectorAll('.new-preview').forEach(el => el.remove());
        if (currentImages.length === 0 && previewContainer.querySelector('p')) previewContainer.innerHTML = '';
        for (const file of newFiles) {
            try {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const container = document.createElement('div');
                    container.className = 'image-container new-preview';
                    container.innerHTML = `
                        <img src="${e.target.result}" alt="Êñ∞‰∏ä‰º†È¢ÑËßà">
                        <span style="position:absolute;top:0;left:0;background:rgba(106,142,174,0.7);color:white;font-size:10px;padding:1px 3px;border-radius:3px;">Êñ∞</span>`;
                    previewContainer.appendChild(container);
                };
                reader.readAsDataURL(file);
            } catch (err) {
                console.error("È¢ÑËßàÁîüÊàêÈîôËØØ:", err);
            }
        }
        showNotification(`Â∑≤ÈÄâÊã©${files.length}Âº†Êñ∞ÂõæÁâáÔºå‰øùÂ≠òÂêéÁîüÊïà`, 'info');
    };

    const form = content.querySelector('#editArticleForm');
    form.onsubmit = async function(e) {
        e.preventDefault();
        const title = document.getElementById('articleTitle').value.trim();
        const category = document.getElementById('articleCategory').value;
        const text = document.getElementById('articleContent').value.trim();
        if (!title || !category || !text) {
            showNotification('Ê†áÈ¢ò„ÄÅÂàÜÁ±ªÂíåÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫', 'error');
            return;
        }
        let newCompressedImages = [];
        if (newFiles.length > 0) {
            showNotification('Ê≠£Âú®Â§ÑÁêÜÂõæÁâá...', 'info');
            const promises = newFiles.map(f => compressImage(f, false).catch(err => {
                showNotification(`ÂõæÁâá${f.name}Â§ÑÁêÜÂ§±Ë¥•: ${err.message}`, 'error');
                return null;
            }));
            newCompressedImages = (await Promise.all(promises)).filter(r => r !== null);
            newFiles = [];
        }
        const finalImages = [...currentImages, ...newCompressedImages];
        if (finalImages.length > 5) {
            showNotification(`ÂõæÁâáÊÄªÊï∞Ôºà${finalImages.length}ÔºâË∂ÖËøá5Âº†ÈôêÂà∂`, 'error');
            return;
        }
        const index = articles.findIndex(a => String(a.id) === String(articleId));
        if (index !== -1) {
            articles[index] = { ...articles[index], title, category, content: text, images: finalImages, date: new Date().toISOString().split('T')[0] };
            await saveData();
            showNotification('ÊñáÁ´†Êõ¥Êñ∞ÊàêÂäü', 'success');
            window.location.hash = `#article/${articleId}`;
        } else {
            showNotification('Êõ¥Êñ∞Â§±Ë¥•ÔºöÊú™ÊâæÂà∞ÊñáÁ´†', 'error');
        }
    };

    content.querySelector('#cancelEditButton').onclick = () => {
        if (confirm('Á°ÆÂÆöÂèñÊ∂àÁºñËæëÔºüÊõ¥ÊîπÂ∞Ü‰∏ç‰ºö‰øùÂ≠ò„ÄÇ')) window.location.hash = `#article/${articleId}`;
    };
    initializeScrollAnimations();
}

function showHome() {
    disconnectScrollAnimations();
    const content = document.getElementById('content');
    if (!content) return;
    content.innerHTML = `
        <h1 class="animate-on-scroll">ÊñáÁ´†ÂàóË°®</h1>
        <div class="filters animate-on-scroll" style="animation-delay: 0.05s;">
            <select id="categoryFilter" title="ÊåâÂàÜÁ±ªÁ≠õÈÄâ">
                <option value="">ÊâÄÊúâÂàÜÁ±ª</option>
                ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
            </select>
            <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢ÊñáÁ´†..." title="ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢">
        </div>
        <div id="adminNewArticleContainer"></div>
        <div class="article-list"></div>`;
    const categoryFilter = content.querySelector('#categoryFilter');
    const searchInput = content.querySelector('#searchInput');
    let currentPage = 1;

    window.updateArticles = (page = 1) => {
        currentPage = page;
        const category = categoryFilter ? categoryFilter.value : '';
        const query = searchInput ? searchInput.value.trim().toLowerCase() : '';
        let filteredArticles = [...articles].reverse();
        if (category) filteredArticles = filteredArticles.filter(a => a.category === category);
        if (query) filteredArticles = filteredArticles.filter(a => (a.title || '').toLowerCase().includes(query) || (a.content || '').toLowerCase().includes(query));
        renderArticles(filteredArticles, query, page);
    };

    if (categoryFilter) categoryFilter.onchange = () => window.updateArticles(1);
    if (searchInput) {
        searchInput.oninput = () => {
            window.updateArticles(1);
            const query = searchInput.value.toLowerCase();
            const suggestionsContainer = searchInput.parentNode;
            let suggestions = suggestionsContainer.querySelector('.search-suggestions');
            if (suggestions) suggestions.remove();
            if (!query) return;
            suggestions = document.createElement('div');
            suggestions.className = 'search-suggestions';
            const matches = articles.filter(a => (a.title || '').toLowerCase().includes(query)).slice(0, 5);
            if (matches.length) {
                suggestions.innerHTML = matches.map(a => `<div class="suggestion" title="${a.title || ''}">${highlightText(a.title || 'Êó†È¢ò', query)}</div>`).join('');
                suggestionsContainer.appendChild(suggestions);
                suggestions.querySelectorAll('.suggestion').forEach(el => {
                    el.onclick = () => {
                        const originalTitle = el.getAttribute('title') || el.textContent;
                        searchInput.value = originalTitle;
                        suggestions.remove();
                        window.updateArticles(1);
                    };
                });
            }
        };
        searchInput.onblur = () => {
            setTimeout(() => {
                const suggestions = searchInput.parentNode.querySelector('.search-suggestions');
                if (suggestions && !suggestions.matches(':hover')) suggestions.remove();
            }, 150);
        };
    }

    renderAdminNewArticle();
    window.updateArticles(1);
}

function renderAdminNewArticle() {
    const container = document.getElementById('adminNewArticleContainer');
    if (!container) return;
    if (isAdmin()) {
        container.innerHTML = `<details class="new-article-toggle animate-on-scroll" style="animation-delay: 0.1s;">
            <summary>ÂèëÂ∏ÉÊñ∞ÊñáÁ´† ¬ª</summary>
            <form id="newArticleForm" class="new-article-form" novalidate>
                <label for="articleTitle">Ê†áÈ¢ò:</label>
                <input type="text" id="articleTitle" required>
                <label for="articleCategory">ÂàÜÁ±ª:</label>
                <select id="articleCategory" required>
                    <option value="" disabled selected>ÈÄâÊã©ÂàÜÁ±ª</option>
                    ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                </select>
                <label for="articleContent">ÂÜÖÂÆπ:</label>
                <textarea id="articleContent" required></textarea>
                <label for="articleImage">ÂõæÁâáÔºàÊúÄÂ§ö5Âº†Ôºâ:</label>
                <input type="file" id="articleImage" accept="image/jpeg,image/png" multiple>
                <div class="image-preview" id="imagePreview">
                    <p style="color:#888;font-size:14px;width:100%;text-align:center;">ÈÄâÊã©ÂõæÁâáÂêéÊòæÁ§∫È¢ÑËßà</p>
                </div>
                <button type="submit">ÂèëÂ∏ÉÊñáÁ´†</button>
            </form>
        </details>`;
        bindNewArticleForm();
    } else {
        container.innerHTML = '';
    }
}

function bindNewArticleForm() {
    const newArticleForm = document.getElementById('newArticleForm');
    if (!newArticleForm) return;
    const imageInput = newArticleForm.querySelector('#articleImage');
    const previewContainer = newArticleForm.querySelector('#imagePreview');
    let newArticleFiles = [];
    if (imageInput && previewContainer) {
        imageInput.onchange = async function() {
            newArticleFiles = Array.from(this.files);
            previewContainer.innerHTML = '';
            if (newArticleFiles.length > 5) {
                showNotification('ÊúÄÂ§öÂèØ‰∏ä‰º†5Âº†ÂõæÁâá', 'error');
                this.value = '';
                newArticleFiles = [];
                previewContainer.innerHTML = '<p style="color:#888;font-size:14px;width:100%;text-align:center;">ÈÄâÊã©ÂõæÁâáÂêéÊòæÁ§∫È¢ÑËßà</p>';
                return;
            }
            if (newArticleFiles.length > 0) {
                for (const file of newArticleFiles) {
                    try {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = "Êñ∞ÂõæÁâáÈ¢ÑËßà";
                            img.style.cssText = 'max-width:80px; max-height:80px; border-radius:4px; margin:5px;';
                            previewContainer.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    } catch (err) {
                        showNotification(`Êó†Ê≥ïÈ¢ÑËßàÂõæÁâá ${file.name}`, 'error');
                    }
                }
            } else {
                previewContainer.innerHTML = '<p style="color:#888;font-size:14px;width:100%;text-align:center;">ÈÄâÊã©ÂõæÁâáÂêéÊòæÁ§∫È¢ÑËßà</p>';
            }
        };
    }
    newArticleForm.onsubmit = async function(e) {
        e.preventDefault();
        const titleInput = document.getElementById('articleTitle');
        const categoryInput = document.getElementById('articleCategory');
        const contentInput = document.getElementById('articleContent');
        const title = titleInput ? titleInput.value.trim() : '';
        const category = categoryInput ? categoryInput.value : '';
        const text = contentInput ? contentInput.value.trim() : '';
        if (!title || !category || !text) {
            showNotification('ËØ∑Â°´ÂÜôÊ†áÈ¢ò„ÄÅÂàÜÁ±ªÂíåÂÜÖÂÆπ', 'error');
            return;
        }
        let compressedImages = [];
        if (newArticleFiles.length > 0) {
            showNotification('Ê≠£Âú®Â§ÑÁêÜÂõæÁâá...', 'info');
            const promises = newArticleFiles.map(f => compressImage(f, false).catch(err => {
                showNotification(`ÂõæÁâá${f.name}Â§ÑÁêÜÂ§±Ë¥•: ${err.message}`, 'error');
                return null;
            }));
            compressedImages = (await Promise.all(promises)).filter(i => i !== null);
            newArticleFiles = [];
        }
        const date = new Date().toISOString().split('T')[0];
        const newId = Date.now().toString();
        articles.push({ id: newId, title, category, content: text, date, images: compressedImages });
        await saveData();
        newArticleForm.reset();
        if (previewContainer) previewContainer.innerHTML = '<p style="color:#888;font-size:14px;width:100%;text-align:center;">ÈÄâÊã©ÂõæÁâáÂêéÊòæÁ§∫È¢ÑËßà</p>';
        const details = document.querySelector('.new-article-toggle');
        if (details) details.open = false;
        showNotification('ÊñáÁ´†ÂèëÂ∏ÉÊàêÂäü', 'success');
        window.updateArticles(1);
    };
}

// === ËØÑËÆ∫Ê∏≤ÊüìÁã¨Á´ãÂáΩÊï∞ ===
function renderCommentsForArticle(articleId, parentId = null, level = 0, container = null) {
    const MAX_NESTING_LEVEL = 3;
    if (!container) container = document.querySelector('.comments');
    if (!container) return;
    // Ê∏≤ÊüìÂâçÊ∏ÖÁ©∫ÂÜÖÂÆπÔºåÈÅøÂÖçÊóßÂÜÖÂÆπÊÆãÁïô
    if (level === 0) container.innerHTML = '';
    const filteredComments = comments.filter(c => String(c.articleId) === String(articleId) && String(c.parentId) === String(parentId));
    if (filteredComments.length === 0 && parentId === null && level === 0) {
        container.innerHTML = '<p style="color:#888;font-size:14px;text-align:center;">ÊöÇÊó†ËØÑËÆ∫ÔºåÂø´Êù•ÂèëË°®Á¨¨‰∏ÄÊù°ÂêßÔºÅ</p>';
        return;
    }
    filteredComments.forEach((comment, index) => {
        const div = document.createElement('div');
        div.className = 'comment animate-on-scroll';
        div.style.marginLeft = `${level * 20}px`;
        div.style.setProperty('--comment-index', index);
        div.innerHTML = `
            <p><strong>${comment.name || 'ÂåøÂêç'}</strong>${comment.comment}</p>
            <small>ÂèëË°®‰∫é ${comment.date || 'Êú™Áü•'}</small>
            ${level < MAX_NESTING_LEVEL ? `<button class="reply-button" data-comment-id="${comment.id}" data-comment-name="${comment.name || 'ÂåøÂêç'}" title="ÂõûÂ§çÊ≠§ËØÑËÆ∫">ÂõûÂ§ç</button>` : ''}
            ${isAdmin() ? `<button class="delete-comment-button" data-comment-id="${comment.id}" title="Âà†Èô§ËØÑËÆ∫">Âà†Èô§</button>` : ''}
            <div id="reply-form-container-${comment.id}" class="reply-form-container" style="display:none;"></div>`;
        container.appendChild(div);
        const replyContainer = div.querySelector(`#reply-form-container-${comment.id}`);
        if (level < MAX_NESTING_LEVEL) {
            renderCommentsForArticle(articleId, comment.id, level + 1, replyContainer);
        }
    });
    initializeScrollAnimations();
}

async function showArticle(articleId) {
    disconnectScrollAnimations();
    const article = articles.find(a => String(a.id) === String(articleId));
    if (!article) {
        showNotification('Êú™ÊâæÂà∞ÊñáÁ´†', 'error');
        window.location.hash = '#home';
        return;
    }
    const content = document.getElementById('content');
    if (!content) return;
    const paragraphs = (article.content || '').split('\n').filter(p => p.trim().length > 0);
    const contentHtml = paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
    content.innerHTML = `
        <div class="article-page" data-article-id="${articleId}">
            <h1 class="animate-on-scroll">${article.title || 'Êó†È¢ò'}</h1>
            <p class="animate-on-scroll" style="animation-delay:0.1s;">ÂàÜÁ±ª: ${article.category || 'Êú™ÂàÜÁ±ª'} | Êó•Êúü: ${article.date || 'Êú™Áü•'}</p>
            ${(Array.isArray(article.images) && article.images.length > 0) ? `
                <div class="gallery animate-on-scroll" style="animation-delay:0.2s;">
                    ${article.images.length > 1 ? '<button class="prev" title="‰∏ä‰∏ÄÂº†">‚óÑ</button>' : ''}
                    <img src="${article.images[0]}" alt="${article.title || 'ÊñáÁ´†'} ÂõæÁâá1" onerror="this.alt='ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•';this.style.display='none';">
                    ${article.images.length > 1 ? '<button class="next" title="‰∏ã‰∏ÄÂº†">‚ñ∫</button>' : ''}
                    ${article.images.length > 1 ? `<div class="counter">1/${article.images.length}</div>` : ''}
                </div>` : ''}
            <div class="article-content animate-on-scroll" style="animation-delay:0.3s;">${contentHtml}</div>
            <hr>
            <h2>ËØÑËÆ∫Âå∫</h2>
            <div class="comments"><p style="text-align:center;color:#888;font-size:14px;">ËØÑËÆ∫Âä†ËΩΩ‰∏≠...</p></div>
            <form id="commentForm" novalidate class="animate-on-scroll" style="animation-delay:0.4s;">
                <h3>ÂèëË°®ËØÑËÆ∫</h3>
                <label for="commentName">‰Ω†ÁöÑÂêçÂ≠ó:</label>
                <input type="text" id="commentName" placeholder="ËÆøÂÆ¢" required>
                <label for="commentText">ËØÑËÆ∫ÂÜÖÂÆπ:</label>
                <textarea id="commentText" placeholder="ËæìÂÖ•‰Ω†ÁöÑËØÑËÆ∫..." required></textarea>
                <div class="char-count" id="commentCharCount">0/500</div>
                <button type="submit">Êèê‰∫§ËØÑËÆ∫</button>
            </form>
        </div>`;
    // ÂàùÂßãÂåñËØÑËÆ∫ËÄÖÂêçÂ≠ó
    const commentNameInput = content.querySelector('#commentName');
    try {
        const savedName = localStorage.getItem('commenterName');
        if (savedName && commentNameInput) commentNameInput.value = savedName;
    } catch (e) {}
    // Ê∏≤ÊüìËØÑËÆ∫
    renderCommentsForArticle(articleId);
    // ÂõæÂ∫ìÂØºËà™
    const gallery = content.querySelector('.gallery');
    if (gallery && article.images.length > 1) {
        let currentIndex = 0;
        const img = gallery.querySelector('img');
        const counter = gallery.querySelector('.counter');
        const prevBtn = gallery.querySelector('.prev');
        const nextBtn = gallery.querySelector('.next');
        function updateGallery() {
            if (img) img.src = article.images[currentIndex];
            if (counter) counter.textContent = `${currentIndex + 1}/${article.images.length}`;
        }
        if (prevBtn) prevBtn.onclick = () => {
            currentIndex = (currentIndex - 1 + article.images.length) % article.images.length;
            updateGallery();
        };
        if (nextBtn) nextBtn.onclick = () => {
            currentIndex = (currentIndex + 1) % article.images.length;
            updateGallery();
        };
        if (img) img.onclick = () => showImageModal(article.images[currentIndex]);
    }
    // ËØÑËÆ∫Êèê‰∫§
    const commentForm = content.querySelector('#commentForm');
    if (commentForm) {
        commentForm.onsubmit = async (e) => {
            e.preventDefault();
            const name = commentNameInput.value.trim();
            const text = content.querySelector('#commentText').value.trim();
            if (!name || !text) {
                showNotification('ËØ∑Â°´ÂÜôÂêçÂ≠óÂíåËØÑËÆ∫ÂÜÖÂÆπ', 'error');
                return;
            }
            if (text.length > 500) {
                showNotification('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩË∂ÖËøá500Â≠óÁ¨¶', 'error');
                return;
            }
            const date = new Date().toISOString().split('T')[0];
            const commentId = Date.now().toString();
            const newComment = { id: commentId, articleId: String(articleId), name, comment: text, date, parentId: null };
            comments.push(newComment);
            try {
                localStorage.setItem('commenterName', name);
            } catch (e) {}
            await saveData();
            showNotification('ËØÑËÆ∫Êèê‰∫§ÊàêÂäü', 'success');
            commentForm.reset();
            commentNameInput.value = name;
            // ÂÖ≥ÈîÆÔºöËØÑËÆ∫Êèê‰∫§ÂêéÂà∑Êñ∞Êï¥‰∏™È°µÈù¢ÔºåÁ°Æ‰øùcommentsÊï∞ÊçÆÂêåÊ≠•
            showArticle(articleId);
        };
        // ÂÆûÊó∂Â≠óÊï∞ÁªüËÆ°
        const commentTextArea = content.querySelector('#commentText');
        const charCountDisplay = content.querySelector('#commentCharCount');
        if (commentTextArea && charCountDisplay) {
            commentTextArea.addEventListener('input', () => {
                const count = commentTextArea.value.length;
                charCountDisplay.textContent = `${count}/500`;
                charCountDisplay.style.color = count > 500 ? '#d16060' : 'inherit';
            });
        }
    }
    // ÁôªÂΩïÁä∂ÊÄÅÊ£ÄÊü•
    let canComment = !!currentUser;
    if (!canComment) {
        if (commentForm) commentForm.style.display = 'none';
        const tips = document.createElement('div');
        tips.className = 'comment-login-tips';
        tips.innerHTML = 'ËØ∑ÂÖà<a href="#" id="loginToComment">ÁôªÂΩï</a>ÂêéÂèëË°®ËØÑËÆ∫';
        content.appendChild(tips);
        content.querySelector('#loginToComment').onclick = (e) => {
            e.preventDefault();
            showAuthModal();
        };
    }
    initializeScrollAnimations();
}

async function deleteComment(commentId, articleId) {
    if (!confirm('Á°ÆÂÆöÂà†Èô§Ê≠§ËØÑËÆ∫ÔºüÔºàÂåÖÊã¨ÂÖ∂ÊâÄÊúâÂõûÂ§çÔºå‰ªÖÈôêÂΩìÂâç‰ºöËØùÔºâ')) return;
    const removeCommentAndReplies = (id) => {
        comments = comments.filter(c => String(c.id) !== String(id));
        const childComments = comments.filter(c => String(c.parentId) === String(id));
        childComments.forEach(child => removeCommentAndReplies(child.id));
    };
    removeCommentAndReplies(commentId);
    await saveData();
    showNotification('ËØÑËÆ∫Â∑≤Âà†Èô§', 'success');
    showArticle(articleId);
}

async function globalActionsHandler(e) {
    const content = document.getElementById('content');

    if (!e.target.closest('.filters') && !e.target.closest('.search-suggestions')) {
        const suggestions = document.querySelector('.search-suggestions');
        if (suggestions) suggestions.remove();
    }

    if (!content || !content.contains(e.target)) return;

    if (e.target.matches('.pagination button') && !e.target.disabled) {
        const page = parseInt(e.target.dataset.page);
        if (!isNaN(page) && window.updateArticles) {
            window.updateArticles(page);
            const listTop = content.querySelector('.article-list')?.offsetTop || content.offsetTop;
            window.scrollTo({ top: listTop - 70, behavior: 'smooth' });
        }
        return;
    }

    if (e.target.classList.contains('edit-button')) {
        const articleId = e.target.dataset.id;
        if (articleId) window.location.hash = `#edit/${articleId}`;
        return;
    }

    if (e.target.classList.contains('delete-button')) {
        const articleId = e.target.dataset.id;
        if (!articleId) return;
        const article = articles.find(a => String(a.id) === String(articleId));
        const msg = `Á°ÆÂÆöÂà†Èô§ÊñáÁ´† "${article ? article.title : 'Ê≠§ÊñáÁ´†'}"Ôºü\nÔºà‰ªÖÈôêÂΩìÂâç‰ºöËØùÔºâ`;
        if (window.confirm(msg)) {
            articles = articles.filter(a => String(a.id) !== String(articleId));
            comments = comments.filter(c => String(c.articleId) !== String(articleId));
            await saveData();
            const currPageInput = document.querySelector('.pagination button.active');
            const currPageNum = currPageInput ? parseInt(currPageInput.dataset.page) : 1;
            const catFilter = document.getElementById('categoryFilter');
            const searchInput = document.getElementById('searchInput');
            const category = catFilter ? catFilter.value : '';
            const query = searchInput ? searchInput.value.trim().toLowerCase() : '';
            let filteredArticles = [...articles].reverse();
            if (category) filteredArticles = filteredArticles.filter(a => a.category === category);
            if (query) filteredArticles = filteredArticles.filter(a => (a.title || '').toLowerCase().includes(query) || (a.content || '').toLowerCase().includes(query));
            const itemsPerPage = 5;
            const articlesOnPage = filteredArticles.slice((currPageNum - 1) * itemsPerPage, currPageNum * itemsPerPage).length;
            const pageToRefresh = (articlesOnPage === 0 && currPageNum > 1) ? currPageNum - 1 : currPageNum;
            if (window.updateArticles) window.updateArticles(pageToRefresh);
            showNotification('ÊñáÁ´†Â∑≤Âà†Èô§', 'success');
        }
        return;
    }

    if (e.target.classList.contains('reply-button')) {
        const parentCommentId = e.target.dataset.commentId;
        const parentCommentName = e.target.dataset.commentName;
        openInlineReplyForm(parentCommentId, parentCommentName, e.target.closest('.comment'));
        return;
    }

    if (e.target.classList.contains('submit-reply')) {
        e.preventDefault();
        const form = e.target.closest('.inline-reply-form');
        if (form) handleInlineReplySubmit(form);
        return;
    }

    if (e.target.classList.contains('cancel-reply')) {
        e.preventDefault();
        const formContainer = e.target.closest('.reply-form-container');
        if (formContainer) closeInlineReplyForm(formContainer);
        return;
    }

    if (e.target.classList.contains('delete-comment-button')) {
        const commentId = e.target.dataset.commentId;
        const articleId = document.querySelector('.article-page')?.dataset.articleId;
        if (commentId && articleId) {
            await deleteComment(commentId, articleId);
        }
        return;
    }
}

// === Inline Reply Form Functions ===
function closeInlineReplyForm(formContainer = null) {
    const containerToClose = formContainer || currentOpenReplyForm;
    if (containerToClose) {
        containerToClose.innerHTML = '';
        containerToClose.style.display = 'none';
    }
    currentOpenReplyForm = null;
}

// ‰øÆÊîπ openInlineReplyFormÔºåÊ∑ªÂä†Â≠óÊï∞ÁªüËÆ°ÂíåÂ≠óÊï∞ÈôêÂà∂
function openInlineReplyForm(parentId, parentName, parentCommentElement) {
    closeInlineReplyForm();
    const containerId = `reply-form-container-${parentId}`;
    let container = document.getElementById(containerId);
    if (!container) {
        container = document.createElement('div');
        container.id = containerId;
        container.className = 'reply-form-container';
        container.style.display = 'none';
        parentCommentElement.appendChild(container);
    }
    let commenterName = '';
    try {
        commenterName = localStorage.getItem('commenterName') || '';
    } catch (e) {}
    container.innerHTML = `
        <form class="inline-reply-form" data-parent-id="${parentId}">
            <label for="inlineReplyName-${parentId}">‰Ω†ÁöÑÂêçÂ≠ó:</label>
            <input type="text" id="inlineReplyName-${parentId}" value="${commenterName}" placeholder="ËÆøÂÆ¢" required>
            <label for="inlineReplyText-${parentId}">ÂõûÂ§ç @${parentName}:</label>
            <textarea id="inlineReplyText-${parentId}" placeholder="ËæìÂÖ•‰Ω†ÁöÑÂõûÂ§ç..." required></textarea>
            <div class="char-count" id="replyCharCount-${parentId}">0/500</div>
            <div class="reply-form-actions">
                <button type="submit" class="submit-reply">Êèê‰∫§ÂõûÂ§ç</button>
                <button type="button" class="cancel-reply">ÂèñÊ∂à</button>
            </div>
        </form>`;
    container.style.display = 'block';
    currentOpenReplyForm = container;
    const textarea = container.querySelector('textarea');
    const replyCharCount = container.querySelector(`#replyCharCount-${parentId}`);
    if (textarea && replyCharCount) {
        textarea.addEventListener('input', () => {
            const count = textarea.value.length;
            replyCharCount.textContent = `${count}/500`;
            replyCharCount.style.color = count > 500 ? '#d16060' : 'inherit';
        });
        textarea.focus();
    }
}

// ‰øÆÊîπ handleInlineReplySubmitÔºåÊ∑ªÂä†Â≠óÊï∞ÈôêÂà∂
async function handleInlineReplySubmit(formElement) {
    const parentId = formElement.dataset.parentId;
    const nameInput = formElement.querySelector('input[type="text"]');
    const commentTextarea = formElement.querySelector('textarea');
    const articleId = document.querySelector('.article-page')?.dataset.articleId;
    if (!parentId || !nameInput || !commentTextarea || !articleId) {
        showNotification('Êèê‰∫§ÂõûÂ§çÂ§±Ë¥•ÔºöÁº∫Â∞ëÂøÖË¶Å‰ø°ÊÅØ', 'error');
        return;
    }
    const name = nameInput.value.trim();
    const commentText = commentTextarea.value.trim();
    if (!name || !commentText) {
        showNotification('ËØ∑Â°´ÂÜôÂêçÂ≠óÂíåÂõûÂ§çÂÜÖÂÆπ', 'error');
        return;
    }
    if (commentText.length > 500) {
        showNotification('ÂõûÂ§çÂÜÖÂÆπ‰∏çËÉΩË∂ÖËøá500Â≠óÁ¨¶', 'error');
        return;
    }
    const date = new Date().toISOString().split('T')[0];
    const commentId = Date.now().toString();
    comments.push({
        id: commentId,
        articleId: String(articleId),
        name,
        comment: commentText,
        date,
        parentId
    });
    try {
        localStorage.setItem('commenterName', name);
    } catch (e) {}
    await saveData();
    showNotification('ÂõûÂ§çÊèê‰∫§ÊàêÂäü', 'success');
    showArticle(articleId);
}

// --- ÂÖ≥‰∫éÈ°µÈù¢ ---
function showAbout() {
    disconnectScrollAnimations();
    const content = document.getElementById('content');
    if (!content) return;
    content.innerHTML = `
        <div class="about-page animate-on-scroll">
            <h1>ÂÖ≥‰∫éÊàë</h1>
            <p>‰Ω†Â•ΩÔºÅÊàëÊòØ Kazama_SuichikuÔºå‰∏Ä‰∏™ÁÉ≠Áà±Ê∏∏ÊàèÂºÄÂèë‰∏éÊäÄÊúØÁæéÊúØÁöÑÁã¨Á´ãÂ≠¶‰π†ËÄÖ„ÄÇ</p>
            <p>Âú®ËøôÈáåÔºåÊàëÂàÜ‰∫´ÊàëÁöÑÂ≠¶‰π†Á¨îËÆ∞„ÄÅÊäÄÊúØÊé¢Á¥¢Ôºå‰ª•ÂèäÁîüÊ¥ª‰∏≠ÁöÑÁÇπÊª¥ÊÑüÊÇü„ÄÇÊó†ËÆ∫ÊòØÊ∑±ÂÖ•Á†îÁ©∂ÁùÄËâ≤Âô®ÔºàShaderÔºâ„ÄÅÁ®ãÂ∫èÂåñÂÜÖÂÆπÁîüÊàêÔºåËøòÊòØËÆ∞ÂΩï‰∏Ä‰∏™ÂÆâÈùôÁöÑÂçàÂêéÔºåÊàëÈÉΩÂ∏åÊúõËøô‰∫õÂÜÖÂÆπËÉΩÁªô‰Ω†Â∏¶Êù•ÁÅµÊÑüÊàñÂÖ±È∏£„ÄÇ</p>
            <p>ÊàëÁöÑÂÖ¥Ë∂£ÂåÖÊã¨‰ΩÜ‰∏çÈôê‰∫éÔºö</p>
            <ul>
                <li><strong>Ê∏∏ÊàèÂºÄÂèë</strong>ÔºöÁÜüÊÇâ Unreal Engine„ÄÅUnityÔºå‰∏ìÊ≥®‰∫éÂÆûÊó∂Ê∏≤Êüì‰∏éËßÜËßâÊïàÊûú„ÄÇ</li>
                <li><strong>ÊäÄÊúØÁæéÊúØ</strong>ÔºöÊé¢Á¥¢ Shader ÁºñÂÜô„ÄÅÁ®ãÂ∫èÂåñÁ∫πÁêÜ„ÄÅÁ≤íÂ≠êÁ≥ªÁªüÁ≠â„ÄÇ</li>
                <li><strong>ÁîüÊ¥ªËÆ∞ÂΩï</strong>ÔºöÁî®ÊñáÂ≠óÊçïÊçâÊó•Â∏∏‰∏≠ÁöÑÂ∞èÁ°ÆÂπ∏„ÄÇ</li>
            </ul>
            <p>Ê¨¢ËøéÈÄöËøáÊàëÁöÑ <a href="https://www.zhihu.com/people/48-52-52-27-65" target="_blank" rel="noopener noreferrer">Áü•‰πé</a>„ÄÅ<a href="https://space.bilibili.com/56807642" target="_blank" rel="noopener noreferrer">Bilibili</a> Êàñ <a href="https://github.com/Kazama-Suichiku" target="_blank" rel="noopener noreferrer">GitHub</a> ‰∏éÊàë‰∫§ÊµÅÔºÅ</p>
            <p>ÊÑøÊàë‰ª¨ÈÉΩËÉΩÂú®Â≠¶‰π†ÁöÑÊóÖÈÄî‰∏≠‰∏çÊñ≠ÊàêÈïøÔºå‰∫´ÂèóÂàõÈÄ†ÁöÑ‰πêË∂£ÔºÅ</p>
        </div>`;
    initializeScrollAnimations();
}

// --- Ë∑ØÁî±Â§ÑÁêÜ ---
function handleRoute() {
    const hash = window.location.hash || '#home';
    const content = document.getElementById('content');
    if (!content) return;

    disconnectScrollAnimations();
    content.innerHTML = '<p style="text-align:center; padding: 50px; color: #888;">Âä†ËΩΩ‰∏≠...</p>';

    if (hash.startsWith('#article/')) {
        const articleId = hash.replace('#article/', '');
        showArticle(articleId);
    } else if (hash.startsWith('#edit/')) {
        const articleId = hash.replace('#edit/', '');
        showEditForm(articleId);
    } else if (hash === '#about') {
        showAbout();
    } else {
        showHome();
    }
}

// --- ËøîÂõûÈ°∂ÈÉ®ÊåâÈíÆ ---
function initializeBackToTop() {
    const button = document.querySelector('.back-to-top');
    if (!button) return;
    const toggleButton = () => {
        if (window.scrollY > 300) {
            button.classList.add('visible');
        } else {
            button.classList.remove('visible');
        }
    };
    window.addEventListener('scroll', toggleButton);
    button.onclick = () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };
}

// === Firebase Áî®Êà∑ËÆ§ËØÅ‰∏éÊï∞ÊçÆÂêåÊ≠• ===
// firebaseÂ∑≤Âú®index.htmlÂàùÂßãÂåñ

// ÂÖ®Â±ÄfirebaseÂºïÁî®
const auth = firebase.auth();
const db = firebase.database();

// Áî®Êà∑Áä∂ÊÄÅ
let currentUser = null;

// ÂºπÁ™óÁôªÂΩï/Ê≥®ÂÜåUI
function showAuthModal() {
    // Ëã•Â∑≤Â≠òÂú®ÂàôÊòæÁ§∫
    let modal = document.getElementById('authModal');
    if (modal) {
        modal.style.display = 'flex';
        return;
    }
    modal = document.createElement('div');
    modal.id = 'authModal';
    modal.className = 'auth-modal';
    modal.innerHTML = `
      <div class="auth-modal-content">
        <div class="auth-tabs">
          <button class="auth-tab active" data-tab="login">ÁôªÂΩï</button>
          <button class="auth-tab" data-tab="register">Ê≥®ÂÜå</button>
        </div>
        <form id="loginForm" class="auth-form">
          <label>ÈÇÆÁÆ±</label>
          <input type="email" id="loginEmail" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±" required autocomplete="username">
          <label>ÂØÜÁ†Å</label>
          <input type="password" id="loginPassword" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required autocomplete="current-password">
          <button type="submit">ÁôªÂΩï</button>
        </form>
        <form id="registerForm" class="auth-form" style="display:none;">
          <label>ÈÇÆÁÆ±</label>
          <input type="email" id="registerEmail" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±" required autocomplete="username">
          <label>ÂØÜÁ†Å</label>
          <input type="password" id="registerPassword" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required autocomplete="new-password">
          <button type="submit">Ê≥®ÂÜå</button>
        </form>
        <div id="authModalStatus" class="auth-modal-status"></div>
        <button class="auth-modal-close" title="ÂÖ≥Èó≠">√ó</button>
      </div>
    `;
    document.body.appendChild(modal);
    // ÂàáÊç¢tab
    const tabs = modal.querySelectorAll('.auth-tab');
    const loginForm = modal.querySelector('#loginForm');
    const registerForm = modal.querySelector('#registerForm');
    tabs.forEach(tab => {
      tab.onclick = () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        if (tab.dataset.tab === 'login') {
          loginForm.style.display = '';
          registerForm.style.display = 'none';
        } else {
          loginForm.style.display = 'none';
          registerForm.style.display = '';
        }
      };
    });
    // ÁôªÂΩï
    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      const email = modal.querySelector('#loginEmail').value.trim();
      const pwd = modal.querySelector('#loginPassword').value;
      try {
        await auth.signInWithEmailAndPassword(email, pwd);
        closeAuthModal();
      } catch (e) {
        setAuthModalStatus('ÁôªÂΩïÂ§±Ë¥•: ' + (e.message || 'Êú™Áü•ÈîôËØØ'), 'error');
      }
    };
    // Ê≥®ÂÜå
    registerForm.onsubmit = async (e) => {
      e.preventDefault();
      const email = modal.querySelector('#registerEmail').value.trim();
      const pwd = modal.querySelector('#registerPassword').value;
      try {
        await auth.createUserWithEmailAndPassword(email, pwd);
        setAuthModalStatus('Ê≥®ÂÜåÊàêÂäüÔºåÂ∑≤Ëá™Âä®ÁôªÂΩï', 'success');
        setTimeout(closeAuthModal, 800);
      } catch (e) {
        setAuthModalStatus('Ê≥®ÂÜåÂ§±Ë¥•: ' + (e.message || 'Êú™Áü•ÈîôËØØ'), 'error');
      }
    };
    // ÂÖ≥Èó≠ÂºπÁ™ó
    modal.querySelector('.auth-modal-close').onclick = closeAuthModal;
    modal.onclick = (e) => { if (e.target === modal) closeAuthModal(); };
    document.addEventListener('keydown', escAuthModal, { once: true });
}
function closeAuthModal() {
    const modal = document.getElementById('authModal');
    if (modal) modal.remove();
}
function escAuthModal(e) {
    if (e.key === 'Escape') closeAuthModal();
}
function setAuthModalStatus(msg, type) {
    const status = document.getElementById('authModalStatus');
    if (status) {
        status.textContent = msg;
        status.className = 'auth-modal-status ' + (type || '');
    }
}

// È°∂ÈÉ®ÂØºËà™Ê†èÁôªÂΩïÁä∂ÊÄÅUI
function showAuthStatusInHeader() {
    const nav = document.querySelector('header nav ul');
    if (!nav) return;
    let statusLi = document.getElementById('authStatusHeaderLi');
    if (!statusLi) {
        statusLi = document.createElement('li');
        nav.appendChild(statusLi);
    }
    statusLi.id = 'authStatusHeaderLi';
    statusLi.innerHTML = '';
    if (currentUser) {
        statusLi.innerHTML = `<span class="auth-header-status">Â∑≤ÁôªÂΩï: <b>${currentUser.email}</b></span><button id="logoutBtnHeader" class="auth-header-logout-btn">ÁôªÂá∫</button>`;
        document.getElementById('logoutBtnHeader').onclick = async () => { await auth.signOut(); };
    } else {
        statusLi.innerHTML = `<button id="openAuthModalBtnHeader" class="auth-header-open-btn">ÁôªÂΩï/Ê≥®ÂÜå</button>`;
        document.getElementById('openAuthModalBtnHeader').onclick = showAuthModal;
    }
}

// ÁõëÂê¨ÁôªÂΩïÁä∂ÊÄÅ
function listenAuthState() {
    auth.onAuthStateChanged(user => {
        currentUser = user;
        showAuthStatusInHeader();
        if (user) loadAvatarFromFirebase();
        if (window.location.hash === '' || window.location.hash === '#home') {
            showHome();
        }
    });
}

// === firebaseÊï∞ÊçÆÂêåÊ≠•ÈÉ®ÂàÜ ===
// ÁõëÂê¨ÊñáÁ´†ÂíåËØÑËÆ∫ÁöÑÂÆûÊó∂ÂèòÂåñ
function listenRealtimeData() {
    db.ref('articles').on('value', snap => {
        const val = snap.val();
        articles = val ? Object.values(val) : [];
        if (window.updateArticles) window.updateArticles(1);
    });
    db.ref('comments').on('value', snap => {
        const val = snap.val();
        comments = val ? Object.values(val) : [];
        console.log('firebase commentsÁõëÂê¨ÂõûË∞ÉËß¶ÂèëÔºåcomments:', comments);
        // Ëã•Âú®ÊñáÁ´†È°µÔºåÁõ¥Êé•Âà∑Êñ∞Êï¥ÁØáÊñáÁ´†Ôºå‰øùËØÅËØÑËÆ∫Âå∫‰∏ÄÂÆöÊ∏≤Êüì
        const hash = window.location.hash;
        if (hash.startsWith('#article/')) {
            const articleId = hash.replace('#article/', '');
            showArticle(articleId);
        }
    });
}

// ‰øùÂ≠òÊñáÁ´†ÂíåËØÑËÆ∫Âà∞firebase
async function saveData() {
    await db.ref('articles').set(Object.fromEntries(articles.map(a => [a.id, a])));
    await db.ref('comments').set(Object.fromEntries(comments.map(c => [c.id, c])));
    showNotification('Êõ¥ÊîπÂ∑≤ÂêåÊ≠•Âà∞‰∫ëÁ´Ø', 'success');
}

// Â§¥ÂÉè‰∏ä‰º†Âà∞firebaseÔºàÊØè‰∏™Áî®Êà∑Áã¨Á´ãÔºâ
async function saveAvatarToFirebase(base64) {
    if (!currentUser) return;
    await db.ref('avatars/' + currentUser.uid).set(base64);
    showNotification('Â§¥ÂÉèÂ∑≤ÂêåÊ≠•Âà∞‰∫ëÁ´Ø', 'success');
}

// ‰ªéfirebaseÂä†ËΩΩÂ§¥ÂÉè
function loadAvatarFromFirebase() {
    if (!currentUser) return;
    db.ref('avatars/' + currentUser.uid).once('value').then(snap => {
        const val = snap.val();
        const profileAvatar = document.getElementById('profileAvatar');
        if (val && profileAvatar) profileAvatar.src = val;
    });
}

// ÊùÉÈôêÂà§Êñ≠Â∑•ÂÖ∑
function isAdmin() {
    return currentUser && currentUser.email === '3196968430@qq.com';
}

// ÂàùÂßãÂåñÊó∂ÁõëÂê¨Êï∞ÊçÆ
function initialize() {
    const yearSpan = document.getElementById('currentYear');
    if (yearSpan) yearSpan.textContent = new Date().getFullYear();

    initializeTheme();

    setTimeout(initializeParticles, 100);

    initAvatarUpload();
    loadAvatar();

    handleRoute();
    window.addEventListener('hashchange', handleRoute);

    initializeBackToTop();

    document.addEventListener('click', globalActionsHandler);

    document.addEventListener('click', (e) => {
        const link = e.target.closest('.article-link');
        if (link) {
            e.preventDefault();
            const articleId = link.dataset.id;
            if (articleId) window.location.hash = `#article/${articleId}`;
        }
    });

    listenAuthState();
    listenRealtimeData();
}

// È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', initialize);

// ======= ËØÑËÆ∫Á≥ªÁªüÈáçÂÜôÔºàÊú¨Âú∞Â≠òÂÇ®ÁâàÔºâ=======
// ËØÑËÆ∫Êï∞ÊçÆÁªìÊûÑÔºö{id, articleId, parentId, name, content, date}
function getLocalComments() {
    try {
        return JSON.parse(localStorage.getItem('localComments') || '[]');
    } catch (e) {
        return [];
    }
}
function saveLocalComments(comments) {
    localStorage.setItem('localComments', JSON.stringify(comments));
}

// Ê∏≤ÊüìËØÑËÆ∫Âå∫
function renderComments(articleId) {
    const container = document.querySelector('.comments');
    if (!container) return;
    const allComments = getLocalComments().filter(c => String(c.articleId) === String(articleId));
    container.innerHTML = '';
    if (allComments.length === 0) {
        container.innerHTML = '<p style="color:#888;font-size:14px;text-align:center;">ÊöÇÊó†ËØÑËÆ∫ÔºåÂø´Êù•ÂèëË°®Á¨¨‰∏ÄÊù°ÂêßÔºÅ</p>';
        return;
    }
    renderCommentTree(allComments, null, 0, container, articleId);
}

function renderCommentTree(comments, parentId, level, container, articleId) {
    if (level > 2) return; // ÊúÄÂ§ö3Á∫ß
    comments.filter(c => c.parentId === parentId).forEach(comment => {
        const div = document.createElement('div');
        div.className = 'comment animate-on-scroll';
        div.style.marginLeft = `${level * 20}px`;
        div.innerHTML = `
            <p><strong>${escapeHtml(comment.name)}</strong>${escapeHtml(comment.content)}</p>
            <small>ÂèëË°®‰∫é ${comment.date}</small>
            <button class="reply-button" data-id="${comment.id}" data-name="${escapeHtml(comment.name)}">ÂõûÂ§ç</button>
            <button class="delete-comment-button" data-id="${comment.id}">Âà†Èô§</button>
            <div class="reply-form-container" style="display:none;"></div>
        `;
        container.appendChild(div);
        // ÁªëÂÆöÂõûÂ§çÊåâÈíÆ
        div.querySelector('.reply-button').onclick = function() {
            openReplyForm(articleId, comment.id, comment.name, div.querySelector('.reply-form-container'));
        };
        // ÁªëÂÆöÂà†Èô§ÊåâÈíÆ
        div.querySelector('.delete-comment-button').onclick = function() {
            if (confirm('Á°ÆÂÆöÂà†Èô§Ê≠§ËØÑËÆ∫ÂèäÂÖ∂ÊâÄÊúâÂõûÂ§çÔºü')) {
                deleteCommentAndReplies(comment.id, articleId);
            }
        };
        // Ê∏≤ÊüìÂ≠êËØÑËÆ∫
        renderCommentTree(comments, comment.id, level + 1, container, articleId);
    });
}

function openReplyForm(articleId, parentId, parentName, container) {
    closeAllReplyForms();
    container.style.display = 'block';
    container.innerHTML = `
        <form class="inline-reply-form">
            <label>‰Ω†ÁöÑÂêçÂ≠ó:</label>
            <input type="text" name="name" placeholder="ËÆøÂÆ¢" required maxlength="20">
            <label>ÂõûÂ§ç @${escapeHtml(parentName)}:</label>
            <textarea name="content" placeholder="ËæìÂÖ•‰Ω†ÁöÑÂõûÂ§ç..." required maxlength="500"></textarea>
            <div class="reply-form-actions">
                <button type="submit" class="submit-reply">Êèê‰∫§ÂõûÂ§ç</button>
                <button type="button" class="cancel-reply">ÂèñÊ∂à</button>
            </div>
        </form>
    `;
    const form = container.querySelector('form');
    form.onsubmit = function(e) {
        e.preventDefault();
        const name = form.name.value.trim() || 'ËÆøÂÆ¢';
        const content = form.content.value.trim();
        if (!content) return alert('ÂõûÂ§çÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫');
        addComment(articleId, parentId, name, content);
        container.style.display = 'none';
    };
    form.querySelector('.cancel-reply').onclick = function() {
        container.style.display = 'none';
    };
}
function closeAllReplyForms() {
    document.querySelectorAll('.reply-form-container').forEach(c => c.style.display = 'none');
}

function addComment(articleId, parentId, name, content) {
    const comments = getLocalComments();
    comments.push({
        id: Date.now().toString() + Math.random().toString(36).slice(2, 8),
        articleId: String(articleId),
        parentId: parentId || null,
        name: name,
        content: content,
        date: new Date().toLocaleString('zh-CN', {hour12: false})
    });
    saveLocalComments(comments);
    renderComments(articleId);
}

function deleteCommentAndReplies(commentId, articleId) {
    let comments = getLocalComments();
    // ÈÄíÂΩíÂà†Èô§ÊâÄÊúâÂ≠êËØÑËÆ∫
    function del(id) {
        comments = comments.filter(c => c.id !== id);
        getLocalComments().filter(c => c.parentId === id).forEach(child => del(child.id));
    }
    del(commentId);
    saveLocalComments(comments);
    renderComments(articleId);
}

function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
}

// Ê∏≤ÊüìËØÑËÆ∫Ë°®Âçï
function renderCommentForm(articleId) {
    const content = document.getElementById('content');
    if (!content) return;
    let form = content.querySelector('#commentForm');
    if (!form) {
        form = document.createElement('form');
        form.id = 'commentForm';
        form.className = 'animate-on-scroll';
        form.innerHTML = `
            <h3>ÂèëË°®ËØÑËÆ∫</h3>
            <label for="commentName">‰Ω†ÁöÑÂêçÂ≠ó:</label>
            <input type="text" id="commentName" placeholder="ËÆøÂÆ¢" maxlength="20">
            <label for="commentText">ËØÑËÆ∫ÂÜÖÂÆπ:</label>
            <textarea id="commentText" placeholder="ËæìÂÖ•‰Ω†ÁöÑËØÑËÆ∫..." required maxlength="500"></textarea>
            <div class="char-count" id="commentCharCount">0/500</div>
            <button type="submit">Êèê‰∫§ËØÑËÆ∫</button>
        `;
        content.appendChild(form);
    }
    // Â≠óÊï∞ÁªüËÆ°
    const textarea = form.querySelector('#commentText');
    const charCount = form.querySelector('#commentCharCount');
    textarea.oninput = function() {
        charCount.textContent = `${textarea.value.length}/500`;
        charCount.style.color = textarea.value.length > 500 ? '#d16060' : '';
    };
    // Êèê‰∫§
    form.onsubmit = function(e) {
        e.preventDefault();
        const name = form.querySelector('#commentName').value.trim() || 'ËÆøÂÆ¢';
        const content = textarea.value.trim();
        if (!content) return alert('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫');
        addComment(articleId, null, name, content);
        textarea.value = '';
        charCount.textContent = '0/500';
    };
}

// ÊñáÁ´†ËØ¶ÊÉÖÈ°µÈõÜÊàêËØÑËÆ∫Âå∫
async function showArticle(articleId) {
    disconnectScrollAnimations();
    const article = articles.find(a => String(a.id) === String(articleId));
    if (!article) {
        showNotification('Êú™ÊâæÂà∞ÊñáÁ´†', 'error');
        window.location.hash = '#home';
        return;
    }
    const content = document.getElementById('content');
    if (!content) return;
    const paragraphs = (article.content || '').split('\n').filter(p => p.trim().length > 0);
    const contentHtml = paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
    content.innerHTML = `
        <div class="article-page" data-article-id="${articleId}">
            <h1 class="animate-on-scroll">${article.title || 'Êó†È¢ò'}</h1>
            <p class="animate-on-scroll" style="animation-delay:0.1s;">ÂàÜÁ±ª: ${article.category || 'Êú™ÂàÜÁ±ª'} | Êó•Êúü: ${article.date || 'Êú™Áü•'}</p>
            ${(Array.isArray(article.images) && article.images.length > 0) ? `
                <div class="gallery animate-on-scroll" style="animation-delay:0.2s;">
                    ${article.images.length > 1 ? '<button class="prev" title="‰∏ä‰∏ÄÂº†">‚óÑ</button>' : ''}
                    <img src="${article.images[0]}" alt="${article.title || 'ÊñáÁ´†'} ÂõæÁâá1" onerror="this.alt='ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•';this.style.display='none';">
                    ${article.images.length > 1 ? '<button class="next" title="‰∏ã‰∏ÄÂº†">‚ñ∫</button>' : ''}
                    ${article.images.length > 1 ? `<div class="counter">1/${article.images.length}</div>` : ''}
                </div>` : ''}
            <div class="article-content animate-on-scroll" style="animation-delay:0.3s;">${contentHtml}</div>
            <hr>
            <h2>ËØÑËÆ∫Âå∫</h2>
            <div class="comments"><p style="text-align:center;color:#888;font-size:14px;">ËØÑËÆ∫Âä†ËΩΩ‰∏≠...</p></div>
            <form id="commentForm" novalidate class="animate-on-scroll" style="animation-delay:0.4s;">
                <h3>ÂèëË°®ËØÑËÆ∫</h3>
                <label for="commentName">‰Ω†ÁöÑÂêçÂ≠ó:</label>
                <input type="text" id="commentName" placeholder="ËÆøÂÆ¢" required>
                <label for="commentText">ËØÑËÆ∫ÂÜÖÂÆπ:</label>
                <textarea id="commentText" placeholder="ËæìÂÖ•‰Ω†ÁöÑËØÑËÆ∫..." required></textarea>
                <div class="char-count" id="commentCharCount">0/500</div>
                <button type="submit">Êèê‰∫§ËØÑËÆ∫</button>
            </form>
        </div>`;
    // ÂàùÂßãÂåñËØÑËÆ∫ËÄÖÂêçÂ≠ó
    const commentNameInput = content.querySelector('#commentName');
    try {
        const savedName = localStorage.getItem('commenterName');
        if (savedName && commentNameInput) commentNameInput.value = savedName;
    } catch (e) {}
    // Ê∏≤ÊüìËØÑËÆ∫Âå∫ÂíåË°®Âçï
    let commentsDiv = document.querySelector('.comments');
    if (!commentsDiv) {
        commentsDiv = document.createElement('div');
        commentsDiv.className = 'comments';
        document.getElementById('content').appendChild(commentsDiv);
    }
    renderCommentForm(articleId);
    renderComments(articleId);
    // ÂõæÂ∫ìÂØºËà™
    const gallery = content.querySelector('.gallery');
    if (gallery && article.images.length > 1) {
        let currentIndex = 0;
        const img = gallery.querySelector('img');
        const counter = gallery.querySelector('.counter');
        const prevBtn = gallery.querySelector('.prev');
        const nextBtn = gallery.querySelector('.next');
        function updateGallery() {
            if (img) img.src = article.images[currentIndex];
            if (counter) counter.textContent = `${currentIndex + 1}/${article.images.length}`;
        }
        if (prevBtn) prevBtn.onclick = () => {
            currentIndex = (currentIndex - 1 + article.images.length) % article.images.length;
            updateGallery();
        };
        if (nextBtn) nextBtn.onclick = () => {
            currentIndex = (currentIndex + 1) % article.images.length;
            updateGallery();
        };
        if (img) img.onclick = () => showImageModal(article.images[currentIndex]);
    }
    // ËØÑËÆ∫Êèê‰∫§
    const commentForm = content.querySelector('#commentForm');
    if (commentForm) {
        commentForm.onsubmit = async (e) => {
            e.preventDefault();
            const name = commentNameInput.value.trim();
            const text = content.querySelector('#commentText').value.trim();
            if (!name || !text) {
                showNotification('ËØ∑Â°´ÂÜôÂêçÂ≠óÂíåËØÑËÆ∫ÂÜÖÂÆπ', 'error');
                return;
            }
            if (text.length > 500) {
                showNotification('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩË∂ÖËøá500Â≠óÁ¨¶', 'error');
                return;
            }
            const date = new Date().toISOString().split('T')[0];
            const commentId = Date.now().toString();
            const newComment = { id: commentId, articleId: String(articleId), name, comment: text, date, parentId: null };
            comments.push(newComment);
            try {
                localStorage.setItem('commenterName', name);
            } catch (e) {}
            await saveData();
            showNotification('ËØÑËÆ∫Êèê‰∫§ÊàêÂäü', 'success');
            commentForm.reset();
            commentNameInput.value = name;
            // ÂÖ≥ÈîÆÔºöËØÑËÆ∫Êèê‰∫§ÂêéÂà∑Êñ∞Êï¥‰∏™È°µÈù¢ÔºåÁ°Æ‰øùcommentsÊï∞ÊçÆÂêåÊ≠•
            showArticle(articleId);
        };
        // ÂÆûÊó∂Â≠óÊï∞ÁªüËÆ°
        const commentTextArea = content.querySelector('#commentText');
        const charCountDisplay = content.querySelector('#commentCharCount');
        if (commentTextArea && charCountDisplay) {
            commentTextArea.addEventListener('input', () => {
                const count = commentTextArea.value.length;
                charCountDisplay.textContent = `${count}/500`;
                charCountDisplay.style.color = count > 500 ? '#d16060' : 'inherit';
            });
        }
    }
    // ÁôªÂΩïÁä∂ÊÄÅÊ£ÄÊü•
    let canComment = !!currentUser;
    if (!canComment) {
        if (commentForm) commentForm.style.display = 'none';
        const tips = document.createElement('div');
        tips.className = 'comment-login-tips';
        tips.innerHTML = 'ËØ∑ÂÖà<a href="#" id="loginToComment">ÁôªÂΩï</a>ÂêéÂèëË°®ËØÑËÆ∫';
        content.appendChild(tips);
        content.querySelector('#loginToComment').onclick = (e) => {
            e.preventDefault();
            showAuthModal();
        };
    }
    initializeScrollAnimations();
}